{% extends "templates/web.html" %}

{% block header %}{% endblock %} <!-- Remove header -->
{% block footer %}{% endblock %} <!-- Remove footer -->

{% block content %}
<div class="container my-5 reports-container">
    <h1 class="text-center mb-4">Reports</h1>
    
    <!-- Stock Details Chart Section -->
    <div id="stock-report" class="mb-5">
        <h2 class="text-primary mb-3">Stock Details</h2>
        <canvas id="stockChart" width="400" height="200"></canvas>
    </div>

    <!-- Pending Job Cards Section -->
    <div id="job-card-report" class="mb-5">
        <h2 class="text-success mb-3">Pending Job Cards</h2>
        {% if job_card_details %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Job Card</th>
                        <th>Operation</th>
                        <th>Employee</th>
                        <th>Expected Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job_card in job_card_details %}
                    <tr>
                        <td>{{ job_card.name }}</td>
                        <td>{{ job_card.operation }}</td>
                        <td>{{ job_card.employee }}</td>
                        <td>{{ job_card.time_required }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-warning">No pending job cards found.</p>
        {% endif %}
    </div>

    <!-- Work Order Details Section -->
    <div id="work-order-report">
        <h2 class="text-info mb-3">Work Order Details</h2>
        {% if work_order_details %}
        <ul class="list-group">
            {% for work_order in work_order_details %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
                {{ work_order.name }}
                <span class="badge bg-primary rounded-pill">{{ work_order.status }}</span>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="text-warning">No work order details available.</p>
        {% endif %}
    </div>
</div>

<!-- Include Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Prepare the data dynamically
    const stockDetails = [
        {% for stock in stock_details %}
            { 
                item: "{{ stock.item_code }}", 
                warehouse: "{{ stock.warehouse }}", 
                quantity: {{ stock.actual_qty }} 
            },
        {% endfor %}
    ];

    // Group data by item and warehouse
    const warehouses = [...new Set(stockDetails.map(stock => stock.warehouse))]; // Unique warehouses
    const items = [...new Set(stockDetails.map(stock => stock.item))]; // Unique items

    // Create a dataset for each warehouse
    const datasets = warehouses.map(warehouse => {
        return {
            label: warehouse,
            data: items.map(item => {
                // Find stock quantity for the given item and warehouse
                const stock = stockDetails.find(stock => stock.item === item && stock.warehouse === warehouse);
                return stock ? stock.quantity : 0; // Default to 0 if no data
            }),
            backgroundColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.5)`,
            borderColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`,
            borderWidth: 1
        };
    });

    // Render the chart
    const ctx = document.getElementById('stockChart').getContext('2d');
    const stockChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: items,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                title: {
                    display: true,
                    text: 'Stock Details by Warehouse'
                }
            },
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    beginAtZero: true,
                    stacked: true
                }
            }
        }
    });
</script>
{% endblock %}
