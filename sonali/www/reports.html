{% extends "templates/web.html" %}

{% block header %}{% endblock %} <!-- Remove header -->
{% block footer %}{% endblock %} <!-- Remove footer -->

{% block content %}
<div class="container my-5 reports-container">
    <h1 class="text-center mb-4">Reports</h1>
    <h2 class="text-success mb-3">Work Orders</h2>
    <div id="work-orders" class="container">
        <!-- Work Order Cards -->
        <div class="row row-cols-1 row-cols-md-2 g-3">
            {% for work_order in work_order_details %}
            <div class="col">
                <div class="card shadow-sm border-0" 
                     style="border-left: 5px solid {% if work_order.status == 'Completed' %}green{% elif work_order.status == 'In Progress' %}orange{% else %}red{% endif %};">
                    <div class="card-body py-3 px-4">
                        <!-- Custom Text Colors -->
                        <h6 class="card-title text-dark text-truncate mb-2"><strong>{{ work_order.name }}</strong></h6>
                        <p class="card-text text-secondary mb-1"><strong>Status:</strong> 
                            <span class="badge {% if work_order.status == 'Completed' %}bg-success{% elif work_order.status == 'In Progress' %}bg-warning{% else %}bg-danger{% endif %}">
                                {{ work_order.status }}
                            </span>
                        </p>
                        <p class="card-text text-info mb-1"><strong>Production Item:</strong> {{ work_order.production_item }}</p>
                        <p class="card-text text-primary"><strong>Quantity:</strong> {{ work_order.qty }}</p>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    
        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center mt-4">
            <button id="prevPage" class="btn btn-outline-primary btn-sm" {% if current_page == 1 %}disabled{% endif %}>Previous</button>
            <span class="text-muted">Page {{ current_page }} of {{ total_pages }}</span>
            <button id="nextPage" class="btn btn-outline-primary btn-sm" {% if current_page == total_pages %}disabled{% endif %}>Next</button>
        </div>
    </div>
    
    <!-- Stock Details Chart Section -->
    <div id="stock-report" class="mb-5">
        <h2 class="text-primary mb-3">Stock Details</h2>
        <canvas id="stockChart" width="400" height="200"></canvas>
    </div>

    <!-- Pending Job Cards Section -->
    <div id="job-card-report" class="mb-5">
        <h2 class="text-success mb-3">Pending Job Cards</h2>
        {% if job_card_details %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>Job Card</th>
                        <th>Operation</th>
                        <th>Employee</th>
                        <th>Status</th>
                        <th>Expected Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for job_card in job_card_details %}
                    <tr>
                        <td>{{ job_card.name }}</td>
                        <td>{{ job_card.operation }}</td>
                        <td>{{ job_card.employee or 'Not Assigned'}}</td>
                        <td>{{ job_card.status }}</td>
                        <td>{{ job_card.time_required }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-warning">No pending job cards found.</p>
        {% endif %}
    </div>

    
    
    <!-- Bottom Gap -->
    <div style="margin-bottom: 50px;"></div>
    
    
</div>

<!-- Include Chart.js from CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Prepare the data dynamically
    const stockDetails = [
        {% for stock in stock_details %}
            { 
                item: "{{ stock.item_code }}", 
                warehouse: "{{ stock.warehouse }}", 
                quantity: {{ stock.actual_qty }} 
            },
        {% endfor %}
    ];

    // Group data by item and warehouse
    const warehouses = [...new Set(stockDetails.map(stock => stock.warehouse))]; // Unique warehouses
    const items = [...new Set(stockDetails.map(stock => stock.item))]; // Unique items

    // Create a dataset for each warehouse
    const datasets = warehouses.map(warehouse => {
        return {
            label: warehouse,
            data: items.map(item => {
                // Find stock quantity for the given item and warehouse
                const stock = stockDetails.find(stock => stock.item === item && stock.warehouse === warehouse);
                return stock ? stock.quantity : 0; // Default to 0 if no data
            }),
            backgroundColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.5)`,
            borderColor: `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 1)`,
            borderWidth: 1
        };
    });

    // Render the chart
    const ctx = document.getElementById('stockChart').getContext('2d');
    const stockChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: items,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                title: {
                    display: true,
                    text: 'Stock Details by Warehouse'
                }
            },
            scales: {
                x: {
                    stacked: true
                },
                y: {
                    beginAtZero: true,
                    stacked: true
                }
            }
        }
    });
    // Pagination for Work Order
    document.getElementById('prevPage').addEventListener('click', () => {
        const currentPage = parseInt(new URLSearchParams(window.location.search).get('page') || 1);
        if (currentPage > 1) {
            window.location.search = `?page=${currentPage - 1}`;
        }
    });
    
    document.getElementById('nextPage').addEventListener('click', () => {
        const currentPage = parseInt(new URLSearchParams(window.location.search).get('page') || 1);
        const totalPages = {{ total_pages }};
        if (currentPage < totalPages) {
            window.location.search = `?page=${currentPage + 1}`;
        }
    });
</script>
{% endblock %}
